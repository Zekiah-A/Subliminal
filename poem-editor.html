<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Editing Poem | Subliminal</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="favicon.ico">
	<link rel="stylesheet" href="./styles.css" />
	<link rel="stylesheet" href="./poem-editor.css">
	<script type="module" src="src/editor/editor-document.js"></script>
	<script type="module" src="src/components/component-registrar.js"></script>
	<script type="module" src="src/components/notification-template.js"></script>
	<script type="module" src="src/components/select-template.js"></script>
	<script type="module" src="src/components/poem-canvas-editor-template.js"></script>
	<script type="module" src="src/server.js"></script>
	<script type="module" src="src/account-manager.js"></script>
	<script type="module" src="src/poem-editor.js"></script>
</head>
<body>
	<dialog id="licenseAgreePopup" class="popup" style="width: max(30%, 500px)">
		<h2>You're almost there!</h2>
		<img src="assets/Celebration.png" style="width: 100%" />
		<p>
			When you click submit, your poem will be uploaded publicly to the poem
			purgatory. For more information, see the license agreement below.
		</p>
		<hr/>
		<h2 style="cursor: pointer" onclick="licenseAgreement.style.display = licenseAgreement.style.display == 'none' ? 'block' : 'none';">
			License agreement +
		</h2>
		<div style="display: none" id="licenseAgreement">
			<p>
				All content on this site must be licensed under the Creative Commons
				Attribution-NonCommercial-ShareAlike 4.0, in order to make open source
				contribution easy, with the underlying source code used to format and
				display that content licensed under the GNU GPL-3 license. Summaries
				of these licenses are available at CC BY-NC-SA and GPL-3.
			</p>
			<p>
				By uploading your work to this site, you give consent for your poem to
				be licensed under Creative Commons
				Attribution-NonCommercial-ShareAlike 4.0.
			</p>
			<p>
				You also agree to allow us permission to store and process your work.
				We can also accept no responsibility, if you write something that gets
				you in trouble with people you know, an institution, or local
				government, you agree that you WILLINGLY chose to upload it here. We
				accept no responsibility how your work is interpreted, and what
				consequences may or may not come as a result of it.
			</p>
			<p>
				You will always be the lone copyright owner of your work, we will
				never take ownership of what you made from you, and we will always
				comply if you ask for your poem to be modified, and or taken down from
				this site.
			</p>
		</div>
		<button type="button" class="popup-button" onclick="licenseAgreePopup.close(); uploadCurrent();">
			Submit
		</button>
	</dialog>
	<dialog id="builtinFreePopup" class="popup">
		<h2>Built-in backgrounds:</h2>
		<p>
			These backgrounds are free for you to use to jazz up your poem's look!
			Drawn and shot by members of the subliminal team.
		</p>
		<div class="background-grid" onclick="if (event.target == this) return
			applyBuiltinBackground(event.target)
			builtinFreePopup.close()
			">
			<!--TODO: Use semantic <figure> element-->
			<div>
				<img loading="lazy" src="./assets/backgrounds/ChilternsWalk.jpg" />
				<div>Taken somewhere in the Chilterns, UK.</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/FinlandIntersection.jpg" />
				<div>
					Taken at an intersection somewhere between Uusikaupunki and
					Helsinki, Finland.
				</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/IsoBoy.jpg" />
				<div>
					A fish that mysteriously disappeared the next day, Island near
					Uusikaupunki, Finland.
				</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/LondonCity.jpg" />
				<div>A bridge to the Tate, London, UK.</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/LondonStreets.jpg" />
				<div>A day in the city, near Farringdon, London, UK.</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/Portheleven.jpg" />
				<div>
					It took standing on a rock in the middle of the sea to get this,
					Portheleven, UK.
				</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/FalmouthShellCave.jpg" />
				<div>
					A really old shell cave, in Gyllyngdune Gardens, Falmouth, UK.
				</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/SnowdoniaPath.jpg" />
				<div>A long path to mount Snowdon (maybe), Wales, UK.</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/SnowdoniaQuarry.jpg" />
				<div>
					A spooky snap of quarry taken from a moving vehicle, Snowdonia,
					Wales, UK.
				</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/SnowdoniaQuarry2.jpg" />
				<div>A sunnier view of the massive quarry, Snowdonia, Wales, UK.</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/SnowdoniaQuarry3.jpg" />
				<div>
					An atmospheric pee(a)k (punny) of a quarry, Snowdonia, Wales, UK.
				</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/UusikaupunkiHorsepower.jpg" />
				<div>
					This boat certainly has more than 5 horsepower, Island near
					Uusikaupunki, Finland.
				</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/YorkshireMoorRoad.jpg" />
				<div>A long, long road, past field and moor, Yorkshire, UK.</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/ChaosDrawing.png" />
				<div>
					Chaos, for those who want to have a bit of zazz around their stuff.
				</div>
			</div>
			<div>
				<img loading="lazy" src="./assets/backgrounds/AbbstraktBird.png" />
				<div>
					Is it a bird? Dog? A secret message of text? All we know is that
					this mascot is iconic.
				</div>
			</div>
		</div>
	</dialog>
	<dialog id="loadPoemPopup" class="popup">
		<h2>Load poem:</h2>
		<input type="file" multiple="true" id="poemImportInput" accept=".json, .txt" style="display: none">
		<div id="loadedContainer" class="vertical-scroll-shadow"></div>
		<button type="button" class="popup-button" onclick="
			poemImportInput.click() // TODO: Use new filesystem access API
			for (let file of poemImportInput.files) {
				let guid = newGuid()
				let reader = new FileReader()
				reader.onload = () => {
					if (file.name.endsWith('.txt')) {
						// TODO: Do a simple \n to our format replacement
						let poemData = {
							summary: '', //meta description
							tags: '', //meta keywords
							cWarning: false, //content warning
							cWarningAdditions: '', //content warning additional notes
							poemName: file.name.split('.txt')[0],
							poemAuthor: 'Unknown', //poem header title
							poemContent: reader.result, //poem html
							pageStyle: 'poem-centre', //poem visual format
							pageBackground: '' //poem background image
						}
						localStorage.setItem(guid, JSON.stringify(poemData))
						loadKey(guid)
					}
					else if (file.name.endsWith('.json')) {
						localStorage.setItem(guid, reader.result)
						loadKey(guid)
					}
					else {
						console.error('Uploaded poem was not a text (.txt) or JSON (.json) file, can not import!')
					}
					fetchStorage()
					loadPoemPopup.close()
				}
				reader.readAsText(file)
			}
			">
			Import from local file
		</button>
		<button type="button" class="popup-button" onclick="loadPoemPopup.close()">
			Done
		</button>
	</dialog>
	<dialog id="editorsPopup" class="popup">
		<h2>Find someone to invite</h2>
		<input type="text" placeholder="Search for user by username" />
		<div id="editorsResults" style="height: 500px"></div>
	</dialog>
	<header class="title-blur" style="z-index: 3">
		<div style="display: flex">
			<h2 id="poemName" onpaste="event.preventDefault()" onkeydown="
				if (event.key === 'Enter') {
					event.preventDefault()
					return false
				}
				" style="display: inline; flex-grow: 1; text-align: right" contenteditable="true">
				Click On Me to Start Editing
			</h2>
			<h2 class="centre" style="display: inline">&nbsp;- By&nbsp;</h2>
			<h2 id="poemAuthor" onpaste="event.preventDefault()" onkeydown="
				if (event.key === 'Enter') {
					event.preventDefault()
					return false
				}
				" style="display: inline; flex-grow: 1; text-align: left" contenteditable="true">
				Click On Me to Start Editing
			</h2>
		</div>
		<hr>
		<div id="formattingToolbar">
			<button type="button" class="toolbar-item" style="width: 72px; min-width: 72px" onclick="this.children[1].style.display = this.children[1].style.display == 'block' ? 'none' : 'block'" onblur="this.children[1].style.display = 'none'">
				<div>File ⯆</div>
				<div class="options" style="width: 140px">
					<div onclick=" params.delete('edit')
						params.delete('append')
						location.href = location.origin + '/poem-editor' + (params ? '?' + params.toString() : '')
						">
						Open new
					</div>
					<div onclick="
						downloadCurrent()
						document.body.appendChild(createFromData('subliminal-notification', { message: 'Successfully downloaded poem data.' }))
					">
						Download poem
					</div>
					<div onclick="saveCurrent()
						document.body.appendChild(createFromData('subliminal-notification', { message: 'Successfully saved poem' }))
						">
						Save poem
					</div>
					<div onclick="loadPoemPopup.showModal()">
						Open another
					</div>
					<div onclick="
						if (!side.getAttribute('collapsed') && side.getAttribute('mode') == 'upload') {
							licenseAgreePopup.showModal()
						}
						else {
							side.setAttribute('mode', 'upload')
							side.removeAttribute('collapsed')
						}
					">
						Upload to site
					</div>
				</div>
			</button>
			<button type="button" class="toolbar-item" onclick="format('undo', null)" style="width: 72px; min-width: 72px">
				<div>↩ undo</div>
			</button>
			<button type="button" class="toolbar-item" onclick="format('redo', null)" style="width: 72px; min-width: 72px">
				<div>redo ↪</div>
			</button>
			<button type="button" class="toolbar-item" onclick="editor.addStyle(styleCodes.bold)">
				<div style="font-weight: bold">B</div>
			</button>
			<button type="button" class="toolbar-item" onclick="editor.addStyle(styleCodes.italic)">
				<div style="font-style: italic">I</div>
			</button>
			<button type="button" class="toolbar-item" onclick="editor.addStyle(styleCodes.monospace)">
				<div style="font-family: monospace">C</div>
			</button>
			<button type="button" class="toolbar-item" onclick="editor.addStyle(styleCodes.superscript)">
				<div>Sup</div>
			</button>
			<button type="button" class="toolbar-item" onclick="editor.addStyle(styleCodes.subscript)">
				<div>Sub</div>
			</button>
			<button type="button" class="toolbar-item" style="position: relative" onclick="formatColourInput.click()">
				<input id="formatColourInput" type="color" class="tool colour-tool-item" value="#000" oninput="
					editor.addStyle(styleCodes.colour, parseInt(this.value.slice(1), '16'))
					formattingColourRect.style.background = this.value
				" style="display: none;">
				<div id="formattingColourRect"></div>
			</button>
			<button type="button" class="toolbar-item">
				<div>🖼️</div>
			</button>
			<div class="toolbar-item separator"></div>
			<button type="button" class="toolbar-item" style="width: 112px; min-width: 112px" onclick="this.children[1].style.display = this.children[1].style.display == 'block' ? 'none' : 'block'" onblur="this.children[1].style.display = 'none'">
				<div>Page layout ⯆</div>
				<div class="options">
					<div onclick="changePageStyle('poem-centre')">Poem centre</div>
					<div onclick="changePageStyle('poem-centre-wide')">Poem wide</div>
					<div onclick="changePageStyle('centre')">Centre</div>
				</div>
			</button>
			<button type="button" class="toolbar-item" style="width: 112px; min-width: 112px" onclick="this.children[1].style.display = this.children[1].style.display == 'block' ? 'none' : 'block'" onblur="this.children[1].style.display = 'none'">
				<div>Background ⯆</div>
				<div class="options">
					<div onclick="document.body.style.background = ''">None</div>
					<div onclick="document.body.style.background = `url(\'${prompt('Enter the background image URL')}\')`">
						From link
					</div>
					<div style="opacity: 0.6">Upload file</div>
					<div onclick="builtinFreePopup.showModal();">
						Built-in free
					</div>
				</div>
			</button>
			<button type="button" class="toolbar-item" onclick=" side.removeAttribute('collapsed')
				side.setAttribute('mode', 'rhyme')
				" style="width: 132px; min-width: 132px">
				<div>Rhyme finder ➕</div>
			</button>
			<button type="button" class="toolbar-item" onclick=" side.removeAttribute('collapsed')
				side.setAttribute('mode', 'coauthor')
				" style="width: 132px; min-width: 132px">
				<div>AI coauthor ➕</div>
			</button>
		</div>
		<hr style="margin-bottom: 0px;">
	</header>
	<main>
		<div class="online-editors">
			<h4 style="margin: 0;">Online editors:</h4>
			<ul>
				<li>
					<img src="assets/DefaultAvatar.png" style="border-radius: 100%; background-color: white" width="48" height="48" />
					<div style=" padding: 4px;
						border-radius: 8px;
						background: linear-gradient(lightblue, blue);
						color: white;
						height: 24px;
						position: relative;
						align-self: center;
						">
						You
					</div>
				</li>
			</ul>
			<button type="button" style="margin-top: 24px" onclick="">Invite editor</button>
		</div>
		<poem-canvas-editor id="poemEditor"></poem-canvas-editor>
		<div id="side" class="document-tools" collapsed="false" mode="upload" onclick="
			if (side.getAttribute('collapsed')) side.removeAttribute('collapsed')
		">
			<div class="side-content" upload>
				<div>
					<div style="display: flex; flex-direction: row; height: 48px">
						<p style="margin: 0px; align-self: center">Poem summary:</p>
					</div>
					<textarea id="summaryArea" type="text" maxlength="160"></textarea>
				</div>
				<div>
					<div style="display: flex; flex-direction: row; height: 48px">
						<p style="margin: 0px; align-self: center">Poem tags:</p>
					</div>
					<div id="tagContainer">
						<button add="true" style="line-height: 64px" onclick="addPoemTag(window.prompt('Enter tag you would like to add'))">
						<span>+ Add tag</span>
						</button>
					</div>
				</div>
				<div>
					<div style="display: flex; flex-direction: row; height: 48px">
						<p style="margin: 0px; align-self: center">Content Warning:</p>
					</div>
					<div id="cWarningContainer" style=" background: var(--button-opaque);
						border-radius: 8px;
						padding: 8px;
						">
						<input type="checkbox" id="cWarningCheckbox" onchange="cWarningNotesInput.disabled = this.checked ? false : true" />
						<label for="cWarningCheckbox"> Enabled</label>
						<input type="text" id="cWarningNotesInput" class="popup-input" placeholder="Additional warning notes" style="width: 100%; height: 24px" disabled="" />
					</div>
				</div>
				<button type="button" class="popup-button" style="flex-grow: inherit" onclick="licenseAgreePopup.showModal()">
					Upload to site
				</button>
			</div>
			<div class="side-content" rhyme>
				<p>Poem Rhyme finder:</p>
				<input id="rhymeFinderInput" style="font-size: 16px" type="text" class="popup-input" placeholder="Enter word" />
				<p style="opacity: 0.6; font-size: 10px">
					Use * to match any word ending, or ?? to match anything within a word,
					for example pai* (paint, pain), p???t (paint, print)
				</p>
				<!--TODO: Call rhymeFinderFind(rhymeFinderInput.value, event.target.dataset.api)-->
				<subliminal-select placeholder="Word search type">
					<option value="ml">Similar meaning</option>
					<option value="sl">Sound like</option>
					<option value="sp">Spelled similarly</option>
					<option value="rel_jjb">Adjectives used to describe</option>
					<option value="rel_jja">Nouns described by</option>
					<option value="rel_rhy">Perfect rhymes</option>
					<option value="rel_nry">Half rhymes</option>
					<option value="rel_nry">Homophones</option>
					<option value="rel_ant">Antonyms</option>
					<option value="rel_nry">Matching consonant</option>
				</subliminal-select>
				<div id="sideRhymeMatches">
					<!--Container for side rhyme match elements-->
				</div>
				<p style="opacity: 0.6; font-size: 10px">
					Credits to datamuse for their fantastic API. https://www.datamuse.com/
				</p>
			</div>
			<div class="side-content" coauthor>
				<p>Poem AI coauthor:</p>
				<span style="opacity: 0.6">Use the subliminal poem writing AI to help cowrite your work!</span
					>
				<subliminal-select placeholder="Base the AI's results off of:">
					<option>My work so far</option>
					<option>Subliminal poems</option>
				</subliminal-select>
				<button type="button" class="popup-button" style="flex-grow: inherit" onclick="alert('An error occurred - please try again later')">
					Start coauthor
				</button>
			</div>
			<div class="side-content" close>
				<div class="side-close-button" onclick=" side.setAttribute('collapsed', true)
					side.setAttribute('mode', 'upload')
					event.stopPropagation()
					">
					<svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20">
						<path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z"></path>
					</svg>
				</div>
			</div>
		</div>
		<a href="./poems" style="z-index: 1" class="back"> &lt;- Back</a>
	</main>
</body>
</html>